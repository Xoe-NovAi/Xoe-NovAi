# ============================================================================
# Xoe-NovAi Phase 1 v0.1.3 - FastAPI RAG Service Dockerfile
# ============================================================================
# Purpose: Multi-stage production build for RAG API with LLM/FAISS
# Guide Reference: Section 6.3.1 (Dockerfile.api)
# Last Updated: 2025-11-01
# Changes from v0.1.2:
#   - Updated version label to 0.1.3
#   - Verified COPY command consistency (no trailing slashes)
#   - Added debug output for troubleshooting
#   - Integrated with version management system
# ============================================================================

# ============================================================================
# STAGE 1: BUILDER
# ============================================================================
FROM python:3.12-slim AS builder

LABEL maintainer="Xoe-NovAi Team"
LABEL version="0.1.3"
LABEL description="RAG API Builder Stage"

# Create non-root user
RUN groupadd -r xoeai && useradd -r -g xoeai xoeai
RUN mkdir -p /home/xoeai && chown -R xoeai:xoeai /home/xoeai

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive

WORKDIR /app

# Copy requirements and wheelhouse
COPY requirements-api.txt /app/requirements-api.txt
COPY wheelhouse /wheels
COPY wheelhouse.tgz /tmp/wheelhouse.tgz

# Extract wheelhouse if provided
RUN if [ -f /tmp/wheelhouse.tgz ]; then mkdir -p /wheels && tar -xzf /tmp/wheelhouse.tgz -C /wheels; fi \
    && if [ -d /wheels ] && [ "$(ls -A /wheels || true)" ]; then echo "wheelhouse detected with $(ls /wheels | wc -l) files"; else echo "no wheelhouse detected"; fi

# Install dependencies strictly offline
RUN pip install --no-index --find-links=/wheels -r /app/requirements-api.txt

# system deps needed for many compiled wheels & builds
RUN apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates build-essential cmake git libopenblas-dev pkg-config curl \
    && rm -rf /var/lib/apt/lists/*

# Install scikit-build-core for llama-cpp-python build
RUN pip install --no-cache-dir scikit-build-core>=0.9.2

# Copy requirements and setup files first for better layer caching
WORKDIR /app

# Copy the entire app directory
COPY app/XNAi_rag_app /app/XNAi_rag_app

# Ensure wheels directory exists and is populated
RUN mkdir -p /wheels
COPY wheelhouse/*.whl /wheels/

# Verify critical files exist
RUN test -f /app/XNAi_rag_app/main.py || (echo "ERROR: main.py not found" && ls -la /app/XNAi_rag_app && exit 1) \
    && test -f /app/XNAi_rag_app/dependencies.py || (echo "ERROR: dependencies.py not found" && exit 1)
COPY requirements-api.txt wheelhouse.tgz ./
COPY versions/ ./versions/

# Update requirements from versions.toml if present
RUN pip install --no-cache-dir toml && \
    if [ -f versions/scripts/update_versions.py ]; then \
      python3 versions/scripts/update_versions.py; \
    fi

# Prepare wheelhouse directory
RUN mkdir -p /wheels /app/logs

# Use either wheelhouse.tgz or wheelhouse directory
COPY wheelhouse.tgz* wheelhouse* /tmp/wheels/
RUN if [ -f /tmp/wheels/wheelhouse.tgz ]; then \
      tar -xzf /tmp/wheels/wheelhouse.tgz -C /wheels; \
    elif [ -d /tmp/wheels/wheelhouse ]; then \
      find /tmp/wheels/wheelhouse -name "*.whl" -exec cp {} /wheels/ \; ; \
    else \
      echo "ERROR: Neither wheelhouse.tgz nor wheelhouse directory found"; \
      exit 1; \
    fi

# Create installation tracking script
RUN echo '#!/bin/bash\n\
log_install() {\n\
    local pkg="$1"\n\
    local status="$2"\n\
    local error="${3:-}"\n\
    echo "$(date -Iseconds) [$status] $pkg ${error:+($error)}" >> /app/logs/pip_install.log\n\
}\n\
\n\
# First pass: install core dependencies with specific versions\n\
pip install --no-cache-dir \\\n\
    "fastapi==${FASTAPI_VERSION}" \\\n\
    "pydantic==${PYDANTIC_VERSION}" \\\n\
    "uvicorn==${UVICORN_VERSION}" || log_install "core-deps" "error" "$?"\n\
\n\
# Second pass: install from wheelhouse\n\
if [ -d /wheels ] && [ "$(ls -A /wheels)" ]; then\n\
    echo "Installing from wheelhouse ($(ls /wheels | wc -l) files)"\n\
    pip install --no-cache-dir --no-deps /wheels/*.whl || log_install "wheelhouse" "error" "$?"\n\
    log_install "wheelhouse" "success"\n\
else\n\
    echo "No wheelhouse detected"\n\
    log_install "wheelhouse" "skipped" "No wheels found"\n\
fi\n\
\n\
# Third pass: install remaining requirements\n\
pip install -r requirements-api.txt || log_install "requirements" "error" "$?"\n\
log_install "requirements" "success"\n\
' > /install.sh && chmod +x /install.sh

# Set environment variables for llama-cpp-python build
ENV CMAKE_ARGS="-DLLAMA_BLAS=ON -DLLAMA_BLAS_VENDOR=OpenBLAS -DLLAMA_AVX2=ON -DLLAMA_FMA=ON -DLLAMA_F16C=ON" \
    FORCE_CMAKE=1 \
    LLAMA_CPP_NO_PYTHON=0

# Run installation with logging
RUN /install.sh

# ============================================================================
# STAGE 2: RUNTIME
# ============================================================================
FROM python:3.12-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    libopenblas0 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

RUN groupadd -g 1001 appuser && useradd -m -u 1001 -g 1001 -s /bin/bash appuser

WORKDIR /app

COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Create directory structure BEFORE copy
RUN mkdir -p /app/XNAi_rag_app/logs /app/XNAi_rag_app/faiss_index /backups /prometheus_data \
    && chown -R appuser:appuser /app /backups /prometheus_data \
    && chmod -R 755 /app /backups /prometheus_data

# Copy application code (no trailing slashes - consistent with other Dockerfiles)
COPY --chown=appuser:appuser app/XNAi_rag_app /app/XNAi_rag_app

# Verify critical files were copied
RUN test -f /app/XNAi_rag_app/main.py || (echo "ERROR: main.py not found" && ls -la /app/XNAi_rag_app && exit 1) && \
    test -f /app/XNAi_rag_app/dependencies.py || (echo "ERROR: dependencies.py not found" && exit 1)

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    LLAMA_CPP_N_THREADS=6 \
    LLAMA_CPP_F16_KV=true \
    LLAMA_CPP_USE_MLOCK=true \
    LLAMA_CPP_USE_MMAP=true \
    OMP_NUM_THREADS=1 \
    OPENBLAS_NUM_THREADS=1 \
    OPENBLAS_CORETYPE=ZEN \
    MKL_DEBUG_CPU_TYPE=5

EXPOSE 8000 8002

HEALTHCHECK --interval=30s --timeout=15s --retries=10 --start-period=180s \
    CMD python3 /app/XNAi_rag_app/healthcheck.py || exit 1

USER appuser

CMD ["uvicorn", "XNAi_rag_app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1", "--log-level", "info"]